<!doctype html><html lang=fr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Comment faire évoluer une application pour la rendre plus robuste et maintenable - Mise en place de tests - Talk To The Duck</title><link rel=apple-touch-icon href=/images/icons/icon-180x180.png sizes=180x180>
<link rel=icon href=/images/icons/icon-32x32.png sizes=32x32 type=image/png>
<link rel=icon href=/images/icons/icon-16x16.png sizes=16x16 type=image/png>
<link rel=icon href=/images/icons/favicon.ico>
<link rel=manifest href=/fr/manifest.json>
<meta name=keywords content>
<meta name=description content><meta itemprop=name content="Comment faire évoluer une application pour la rendre plus robuste et maintenable - Mise en place de tests">
<meta itemprop=description content><meta itemprop=datePublished content="2023-01-15T00:00:00+00:00">
<meta itemprop=dateModified content="2023-01-15T00:00:00+00:00">
<meta itemprop=wordCount content="1788">
<meta itemprop=keywords content=","><meta property="og:title" content="Comment faire évoluer une application pour la rendre plus robuste et maintenable - Mise en place de tests">
<meta property="og:description" content>
<meta property="og:type" content="article">
<meta property="og:url" content="/fr/posts/comment-faire-evoluer-une-application-pour-la-rendre-plus-robuste-et-maintenable-mise-en-place-de-tests/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2023-01-15T00:00:00+00:00">
<meta property="article:modified_time" content="2023-01-15T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Comment faire évoluer une application pour la rendre plus robuste et maintenable - Mise en place de tests">
<meta name=twitter:description content>
<meta name=robots content="index, follow"><link rel=stylesheet href=/css/main.min.bdac26feededc335ec4311c668376189bbfe162d3dc6063df0d592d8d855725c.css integrity="sha256-vawm/u3twzXsQxHGaDdhibv+Fi09xgY98NWS2NhVclw=" crossorigin=anonymous><link rel=stylesheet href=/css/viewer.min.3d228794bcedbbfa0412beb8fbc1ec6973202945e42af7004f742a4d7bd620ab.css integrity="sha256-PSKHlLztu/oEEr64+8HsaXMgKUXkKvcAT3QqTXvWIKs=" crossorigin=anonymous></head>
<body><script>const items=['mode','palette'];items.forEach(function(a){const b=localStorage.getItem('hbs-'+a);b&&document.body.parentElement.setAttribute('data-'+a,b)})</script><header><nav class="navbar top-app-bar top-app-bar-expand-lg fixed-top">
<div class=container>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<i class="fas fa-bars"></i>
</button><a class="navbar-brand me-3" href=/fr/><img class=logo alt=Logo src=/images/ttd-logo.webp loading=lazy width=136 height=136>
Talk To The Duck
</a>
<div class="offcanvas offcanvas-bottom surface" tabindex=-1 id=offcanvasSocialShare aria-labelledby=offcanvasSocialShare>
<div class=offcanvas-header>
<h3 class=offcanvas-title>Share</h3>
<button type=button class="btn btn-sm btn-outline-primary" data-bs-dismiss=offcanvas aria-label=Close>
<i class="fas fa-times"></i>
</button>
</div>
<div class=offcanvas-body>
<a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Twitter Share Button" target=_blank href="https://twitter.com/intent/tweet?title=Comment%20faire%20%c3%a9voluer%20une%20application%20pour%20la%20rendre%20plus%20robuste%20et%20maintenable%20-%20Mise%20en%20place%20de%20tests&url=%2ffr%2fposts%2fcomment-faire-evoluer-une-application-pour-la-rendre-plus-robuste-et-maintenable-mise-en-place-de-tests%2f">
<i class="fab fa-fw fa-twitter"></i> Twitter
</a>
<a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Facebook Share Button" target=_blank href="https://www.facebook.com/sharer/sharer.php?u=%2ffr%2fposts%2fcomment-faire-evoluer-une-application-pour-la-rendre-plus-robuste-et-maintenable-mise-en-place-de-tests%2f">
<i class="fab fa-fw fa-facebook-f"></i> Facebook
</a>
</div>
</div>
<button class=navbar-settings type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasSettings aria-controls=offcanvasSettings aria-label="Toggle settings">
<i class="fas fa-ellipsis-v"></i>
</button>
<div class="offcanvas offcanvas-end surface h-100" tabindex=-1 id=offcanvasSettings aria-labelledby=offcanvasSettings>
<div class=offcanvas-header>
<h3 class=offcanvas-title>Réglages</h3>
<button type=button class="btn btn-sm btn-outline-primary" data-bs-dismiss=offcanvas aria-label=Close>
<i class="fas fa-times"></i>
</button>
</div>
<div class="offcanvas-body d-flex flex-column"><section class=setting>
<form class=row>
<div class=col-auto>
<label for=fontSize class=form-label><i class="fas fa-fw fa-language"></i> Language</label>
</div>
<div class="col-auto ms-auto">
<div class=dropdown>
<a class="btn btn-sm btn-outline-primary dropdown-toggle" href=# id=languageDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
Français
</a>
<ul class="dropdown-menu dropdown-menu-end" aria-labelledby=languageDropdown><li><a class=dropdown-item href=/en/>English</a></li><li><a class=dropdown-item href=/it/>Italiano</a></li></ul>
</div>
</div>
</form>
</section>
<section class=setting>
<form class=row>
<div class=col-auto>
<label><i class="fas fa-fw fa-adjust"></i> Mode</label>
</div>
<div class="col-auto ms-auto">
<div class="form-check form-switch">
<input class=form-check-input type=checkbox id=modeSwitcher>
</div>
</div>
</form>
</section>
<section class=setting>
<form class="font-size-switcher-form row">
<div class=col-auto>
<label for=fontSize class=form-label><i class="fas fa-fw fa-font"></i> Taille de la Police</label>
</div>
<div class="col-auto ms-auto">
<input type=range class=form-range min=-2 max=2 id=fontSize>
</div>
</form>
</section>
<section class="setting palettes">
<form class=row>
<div class=col-auto>
<label><i class="fas fa-fw fa-palette"></i> Palette</label>
</div>
<div class="col-auto ms-auto">
<a id=btnPalette class="btn btn-sm btn-outline-primary" role=button aria-label=palettePicker>
<i class="fas fa-eye-dropper"></i>
</a>
</div>
</form>
<div class="mt-2 d-flex visually-hidden" id=palettePicker><button type=button id=palette-blue aria-label=Bleu class="btn btn-sm palette" data-palette=blue>
</button><button type=button id=palette-blue-gray aria-label="Blue Gris" class="btn btn-sm palette" data-palette=blue-gray>
</button><button type=button id=palette-brown aria-label=Marron class="btn btn-sm palette" data-palette=brown>
</button><button type=button id=palette-cyan aria-label=Cyan class="btn btn-sm palette" data-palette=cyan>
</button><button type=button id=palette-green aria-label=Vert class="btn btn-sm palette" data-palette=green>
</button><button type=button id=palette-indigo aria-label=Indigo class="btn btn-sm palette" data-palette=indigo>
</button><button type=button id=palette-orange aria-label=Orange class="btn btn-sm palette" data-palette=orange>
</button><button type=button id=palette-pink aria-label=Rose class="btn btn-sm palette" data-palette=pink>
</button><button type=button id=palette-purple aria-label=Mauve class="btn btn-sm palette" data-palette=purple>
</button><button type=button id=palette-red aria-label=Rouge class="btn btn-sm palette" data-palette=red>
</button><button type=button id=palette-teal aria-label="Bleu Turquoise" class="btn btn-sm palette" data-palette=teal>
</button><button type=button id=palette-yellow aria-label=Jaune class="btn btn-sm palette" data-palette=yellow>
</button></div>
</section>
<section class="setting actions d-flex justify-content-around mt-auto overflow-auto">
<a role=button class="action action-reload-page">
<span class=action-icon><i class="fas fa-2x fa-redo-alt"></i></span> Reload
</a>
<a role=button class="action action-copy-url">
<span class=action-icon><i class="fas fa-2x fa-link"></i></span> Copier URL
</a><a class="action action-social-share" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasSocialShare aria-controls=offcanvasSocialShare aria-label="Toggle social share">
<span class=action-icon><i class="fas fa-2x fa-share-alt"></i></span> Share
</a></section>
</div>
</div>
<div class="collapse navbar-collapse" tabindex=-1 id=navbarSupportedContent aria-labelledby=navbarSupportedContent>
<form class="search-bar my-1" action=/fr/search>
<div class="input-group input-group-sm">
<span class="btn btn-search disabled position-absolute left-0"><i class="fas fa-fw fa-search"></i></span>
<input class="form-control rounded-pill" name=q type=search aria-label=Search>
</div>
</form>
<ul class="navbar-nav ms-auto"><li class=nav-item>
<a class=nav-link href=/fr/series/>
<i class="fas fa-fw fa-columns"></i>Séries
</a>
</li><li class=nav-item>
<a class=nav-link href=/fr/archives/>
<i class="fas fa-fw fa-file-archive"></i>Archives
</a>
</li><li class=nav-item>
<a class=nav-link href=/fr/categories/>
<i class="fas fa-fw fa-folder"></i>Catégories
</a>
</li><li class=nav-item>
<a class=nav-link href=/fr/tags/>
<i class="fas fa-fw fa-tags"></i>Tags
</a>
</li><li class=nav-item>
<a class=nav-link href=/>
</a>
</li></ul>
</div>
</div>
</nav>
</header>
<main role=main class=container>
<div class="row content">
<div class=col-lg-8>
<div class=container><nav class="row card component" aria-label=breadcrumb>
<div class=card-body>
<ol class=breadcrumb><li class=breadcrumb-item><a href=/fr/>Accueil</a></li><li class=breadcrumb-item><a href=/fr/posts/>Articles</a></li><li class="breadcrumb-item active">Comment Faire Évoluer Une Application Pour La Rendre Plus Robuste Et Maintenable - Mise en Place De Tests</li></ol>
</div>
</nav><article class="row card component mb-4 post"><div class=post-panel-wrapper>
<div class="d-flex flex-column component rounded post-panel">
<a class="action action-panel-toggler" role=button title="Panel toggler">
<i class="fas fa-fw fa-chevron-circle-down"></i>
</a>
<a id=sidebarToggler class="action d-none d-lg-block" role=button title="Sidebar toggler">
<i class="fas fa-fw fa-expand-alt" data-fa-transform=rotate-45></i>
</a>
<div class="post-translations nav-item dropdown dropstart action">
<a class="nav-link p-0" data-bs-toggle=dropdown href=# role=button aria-haspopup=true aria-expanded=false aria-label="Translations dropdown menu" title=Translations>
<i class="fas fa-fw fa-language"></i>
</a>
<div class=dropdown-menu><a class="dropdown-item post-translation" href=/en/posts/how-to-evolve-application-tests/>English</a></div>
</div>
<a class=action href=#post-copyright role=button aria-label=Copyright title=Copyright>
<i class="fas fa-fw fa-copyright"></i>
</a>
<a class=action href=#post-comments role=button aria-label=Comments title=Comments>
<i class="fas fa-fw fa-comments"></i>
</a>
<a class=action data-bs-toggle=offcanvas href=#offcanvasTOC aria-controls=offcanvasTOC role=button title="Table of contents">
<i class="fas fa-fw fa-list-alt"></i>
</a>
</div>
</div>
<div class=card-header>
<h1 class="card-title post-title">Comment Faire Évoluer Une Application Pour La Rendre Plus Robuste Et Maintenable - Mise en Place De Tests
</h1>
</div>
<div class=card-body><div class=post-meta>
<span class=post-date title="created on 2023-01-15 00:00:00 +0000 UTC.">
15-01-2023
</span><span class=post-reading-time>
9 min de lecture
</span><span class=post-taxonomies><a href=/fr/categories/qualit%C3%A9/ class="badge rounded-pill post-taxonomy">qualité</a><a href=/fr/categories/test/ class="badge rounded-pill post-taxonomy">test</a><a href=/fr/series/comment-faire-%C3%A9voluer-une-application-pour-la-rendre-plus-robuste-et-maintenable/ class="badge rounded-pill post-taxonomy">Comment faire évoluer une application pour la rendre plus robuste et maintenable</a></span>
</div>
<div class="offcanvas offcanvas-end surface h-100" tabindex=-1 id=offcanvasTOC aria-labelledby=offcanvasTOCLabel>
<div class=offcanvas-header>
<h2 class=offcanvas-title id=offcanvasTOCLabel>Sommaire</h5>
<button type=button class="btn btn-sm btn-outline-primary" data-bs-dismiss=offcanvas aria-label=Close>
<i class="fas fa-times"></i>
</button>
</div>
<div class=offcanvas-body>
<nav id=TableOfContents>
<ul>
<li><a href=#préambule>Préambule</a></li>
<li><a href=#définitions-des-différents-types-de-tests>Définitions des différents types de tests</a></li>
<li><a href=#tests-unitaires>Tests unitaires</a>
<ul>
<li><a href=#paramétrage-du-test>Paramétrage du test</a></li>
<li><a href=#mise-en-place-dun-test>Mise en place d’un test</a></li>
<li><a href=#exemple-de-test>Exemple de test</a></li>
<li><a href=#détail-du-code>Détail du code</a></li>
</ul>
</li>
<li><a href=#tests-dintégrations>Tests d’intégrations</a>
<ul>
<li><a href=#paramétrage-du-test-1>Paramétrage du test</a></li>
<li><a href=#mise-en-place-dun-test-1>Mise en place d’un test</a></li>
<li><a href=#détail-du-code-1>Détail du code</a></li>
</ul>
</li>
<li><a href=#tests-system>Tests system</a>
<ul>
<li><a href=#paramétrage-du-test-2>Paramétrage du test</a></li>
<li><a href=#mise-en-place-dun-test-2>Mise en place d’un test</a></li>
<li><a href=#détails-du-code>Détails du code</a></li>
</ul>
</li>
<li><a href=#résumé>Résumé</a></li>
</ul>
</nav>
</div>
</div><div class="post-content mb-3"><h1 id=série-comment-faire-évoluer-une-application---mise-en-place-des-tests>Série Comment faire évoluer une application - Mise en place des Tests<a class="anchor ms-1" href=#série-comment-faire-évoluer-une-application---mise-en-place-des-tests><i class="fas fa-link"></i></a></h1>
<h2 id=préambule>Préambule<a class="anchor ms-1" href=#préambule><i class="fas fa-link"></i></a></h2>
<p>Dans l’article d’introduction de cette série (lien) nous avons présenté les différents problèmes de notre application (ajouter le lien). Le premier que je vous propose de résoudre dans cet article est l’ajout de tests. <br>
Cet ajout de tests n’a pas pour unique but de couvrir du code et faire passer une quality gate ; il est là pour valider les règles métier et permettre une refactorisation avec moins de risques.
Dans cet article, nous verrons comment ajouter des tests à une application qui n’en a pas.
On abordera les tests unitaires, les tests d’intégrations et les tests de systèmes.</p>
<h2 id=définitions-des-différents-types-de-tests>Définitions des différents types de tests<a class="anchor ms-1" href=#définitions-des-différents-types-de-tests><i class="fas fa-link"></i></a></h2>
<p>Un test unitaire est un test qui ne vérifie que la méthode d’une classe ou une classe. Les classes externes, souvent appelées “collaborateurs”, qui pourraient être appelées seront mockées. Nous placerons des tests unitaires essentiellement sur les services qui doivent contenir le code métier, c&rsquo;est-à-dire le code avec de la valeur ajoutée.
Un test d’intégration est un test qui à pour objectif de vérifier la bonne intégration de certaines parties d’un traitement et non celui-ci dans son ensemble. On concentrera nos tests d’intégration sur les endpoints et les repositories.
Un test système est un test en boite noir qui va vérifier que l’ensemble du cas d&rsquo;utilisation fonctionne.</p>
<p><img class=img-fluid alt=test_pyramid4.png src=/fr/posts/comment-faire-evoluer-une-application-pour-la-rendre-plus-robuste-et-maintenable-mise-en-place-de-tests/test-pyramid.png loading=lazy width=500 height=433>
</p>
<p>Dans un cas comme celui de notre application, où aucun test n’existe, il est préférable de partir sur un test système pour vérifier rapidement le bon fonctionnement et la non-régression d’une fonctionnalité puis par la suite d’augmenter les tests unitaires et les tests d’intégration.</p>
<h2 id=tests-unitaires>Tests unitaires<a class="anchor ms-1" href=#tests-unitaires><i class="fas fa-link"></i></a></h2>
<p>Notre application étant en java, nous utiliserons comme librairies pour les tests :
Junit5, Mockito et AssertJ.</p>
<h3 id=paramétrage-du-test>Paramétrage du test<a class="anchor ms-1" href=#paramétrage-du-test><i class="fas fa-link"></i></a></h3>
<p>Les dépendances sont à ajouter dans le build.gradle mais pour des raisons de lisibilité, je préfère créer un fichier unit-test.gradle qui contiendra toutes les configurations nécessaires.
Ce fichier est appelé par le fichier build.gradle</p>
<p><strong>Emplacement du fichier unit-test.gradle</strong></p>
<p><img class=img-fluid alt=unit-test-gradle-file-location src=/fr/posts/comment-faire-evoluer-une-application-pour-la-rendre-plus-robuste-et-maintenable-mise-en-place-de-tests/unit-test-gradle-file-location.png loading=lazy width=297 height=166>
</p>
<p><strong>Contenu du fichier unit-test.gradle</strong></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=ln>1</span><span class=n>dependencies</span> <span class=o>{</span>
<span class=ln>2</span>
<span class=ln>3</span>   <span class=n>testImplementation</span> <span class=nl>group:</span> <span class=s1>&#39;org.junit.jupiter&#39;</span><span class=o>,</span> <span class=nl>name:</span> <span class=s1>&#39;junit-jupiter&#39;</span><span class=o>,</span> <span class=nl>version:</span> <span class=s1>&#39;5.8.2&#39;</span>
<span class=ln>4</span>   <span class=n>testImplementation</span> <span class=nl>group:</span> <span class=s1>&#39;org.mockito&#39;</span><span class=o>,</span> <span class=nl>name:</span> <span class=s1>&#39;mockito-junit-jupiter&#39;</span><span class=o>,</span> <span class=nl>version:</span> <span class=s1>&#39;4.2.0&#39;</span>
<span class=ln>5</span>   <span class=n>testImplementation</span> <span class=nl>group:</span> <span class=s1>&#39;org.assertj&#39;</span><span class=o>,</span> <span class=nl>name:</span> <span class=s1>&#39;assertj-core&#39;</span><span class=o>,</span> <span class=nl>version:</span> <span class=s1>&#39;3.21.0&#39;</span>
<span class=ln>6</span>   <span class=n>testImplementation</span> <span class=nl>group:</span> <span class=s1>&#39;org.mockito&#39;</span><span class=o>,</span> <span class=nl>name:</span> <span class=s1>&#39;mockito-core&#39;</span><span class=o>,</span> <span class=nl>version:</span> <span class=s1>&#39;4.2.0&#39;</span>
<span class=ln>7</span><span class=o>}</span>
<span class=ln>8</span>
</code></pre></div><p><strong>Dans le fichier build.gradle</strong></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=ln>1</span><span class=n>apply</span> <span class=nl>from:</span> <span class=s2>&#34;gradle/unit-test.gradle&#34;</span>
</code></pre></div><h3 id=mise-en-place-dun-test>Mise en place d’un test<a class="anchor ms-1" href=#mise-en-place-dun-test><i class="fas fa-link"></i></a></h3>
<p>Les règles pour écrire un test unitaire :</p>
<ul>
<li>Chaque test doit être créé dans le répertoire test</li>
<li>Chaque classe de test se trouve dans le même package que la classe qu’il teste</li>
<li>Le nom des méthodes de tests sont en snack_case (cf <a href=https://en.wikipedia.org/wiki/Snake_case target=_blank rel="noopener noreferrer">https://en.wikipedia.org/wiki/Snake_case</a>
)</li>
<li>Le nombre de choses testées doit être limité, idéalement à 1.</li>
</ul>
<h3 id=exemple-de-test>Exemple de test<a class="anchor ms-1" href=#exemple-de-test><i class="fas fa-link"></i></a></h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=ln> 1</span>
<span class=ln> 2</span><span class=nd>@Test</span>
<span class=ln> 3</span><span class=kt>void</span> <span class=nf>should_add_question_to_form</span><span class=o>()</span> <span class=o>{</span>
<span class=ln> 4</span> <span class=c1>// given
</span><span class=ln> 5</span><span class=c1></span> <span class=n>var</span> <span class=n>formId</span> <span class=o>=</span> <span class=n>UUID</span><span class=o>.</span><span class=na>fromString</span><span class=o>(</span><span class=s>&#34;18b8f2e2-f41c-4ca4-a007-c328390cd099&#34;</span><span class=o>);</span>
<span class=ln> 6</span> <span class=n>var</span> <span class=n>savedForm</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Form</span><span class=o>();</span>
<span class=ln> 7</span> <span class=n>var</span> <span class=n>existingQuestion</span> <span class=o>=</span> <span class=k>new</span> <span class=n>QuestionAnswer</span><span class=o>(</span><span class=n>formId</span><span class=o>,</span> <span class=s>&#34;What is your first name&#34;</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=n>savedForm</span><span class=o>);</span>
<span class=ln> 8</span> <span class=n>var</span> <span class=n>questions</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;</span><span class=n>QuestionAnswer</span><span class=o>&gt;();</span>
<span class=ln> 9</span> <span class=n>questions</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>existingQuestion</span><span class=o>);</span>
<span class=ln>10</span> <span class=n>savedForm</span><span class=o>.</span><span class=na>setQuestions</span><span class=o>(</span><span class=n>questions</span><span class=o>);</span>
<span class=ln>11</span> <span class=n>savedForm</span><span class=o>.</span><span class=na>setId</span><span class=o>(</span><span class=n>formId</span><span class=o>);</span>
<span class=ln>12</span>
<span class=ln>13</span> <span class=n>BDDMockito</span><span class=o>.</span><span class=na>when</span><span class=o>(</span><span class=n>formRepository</span><span class=o>.</span><span class=na>getById</span><span class=o>(</span><span class=n>formId</span><span class=o>)).</span><span class=na>thenReturn</span><span class=o>(</span><span class=n>savedForm</span><span class=o>);</span>
<span class=ln>14</span>
<span class=ln>15</span> <span class=n>var</span> <span class=n>questionToSave</span> <span class=o>=</span>
<span class=ln>16</span>     <span class=k>new</span> <span class=n>QuestionAnswer</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=s>&#34;What is your objectives for the next year&#34;</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
<span class=ln>17</span>
<span class=ln>18</span> <span class=c1>// when
</span><span class=ln>19</span><span class=c1></span> <span class=n>formService</span><span class=o>.</span><span class=na>createQuestion</span><span class=o>(</span><span class=n>formId</span><span class=o>,</span> <span class=n>questionToSave</span><span class=o>);</span>
<span class=ln>20</span>
<span class=ln>21</span> <span class=c1>// then
</span><span class=ln>22</span><span class=c1></span> <span class=n>var</span> <span class=n>questionAnswerArgumentCaptor</span> <span class=o>=</span> <span class=n>ArgumentCaptor</span><span class=o>.</span><span class=na>forClass</span><span class=o>(</span><span class=n>QuestionAnswer</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
<span class=ln>23</span>
<span class=ln>24</span> <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>questionAnswerRepository</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>save</span><span class=o>(</span><span class=n>questionAnswerArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
<span class=ln>25</span> <span class=n>var</span> <span class=n>actualQuestions</span> <span class=o>=</span> <span class=n>questionAnswerArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
<span class=ln>26</span> <span class=n>BDDSoftAssertions</span><span class=o>.</span><span class=na>thenSoftly</span><span class=o>(</span>
<span class=ln>27</span>     <span class=n>softly</span> <span class=o>-&gt;</span> <span class=o>{</span>
<span class=ln>28</span>       <span class=n>softly</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>actualQuestions</span><span class=o>).</span><span class=na>isNotNull</span><span class=o>();</span>
<span class=ln>29</span>       <span class=n>softly</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>actualQuestions</span><span class=o>)</span>
<span class=ln>30</span>               <span class=o>.</span><span class=na>extracting</span><span class=o>(</span><span class=s>&#34;form.questions&#34;</span><span class=o>,</span> <span class=n>Assertions</span><span class=o>.</span><span class=na>as</span><span class=o>(</span><span class=n>InstanceOfAssertFactories</span><span class=o>.</span><span class=na>COLLECTION</span><span class=o>))</span>
<span class=ln>31</span>               <span class=o>.</span><span class=na>hasSize</span><span class=o>(</span><span class=n>2</span><span class=o>);</span>
<span class=ln>32</span>     <span class=o>});</span>
<span class=ln>33</span><span class=o>}</span>
<span class=ln>34</span>
</code></pre></div><h3 id=détail-du-code>Détail du code<a class="anchor ms-1" href=#détail-du-code><i class="fas fa-link"></i></a></h3>
<p>Les points les plus importants sont :</p>
<ul>
<li>L&rsquo;utilisation de mock pour simuler le comportement des méthodes d’autre classes qui sont appelées</li>
</ul>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=ln>1</span><span class=n>BDDMockito</span><span class=o>.</span><span class=na>when</span><span class=o>(</span><span class=n>formRepository</span><span class=o>.</span><span class=na>getById</span><span class=o>(</span><span class=n>formId</span><span class=o>)).</span><span class=na>thenReturn</span><span class=o>(</span><span class=n>savedForm</span><span class=o>);</span>
<span class=ln>2</span>
</code></pre></div><ul>
<li>L’utilisation d’ArgumentCaptor pour choper et ensuite valider le formulaire passé à la méthode save du repository</li>
</ul>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=ln>1</span> <span class=n>var</span> <span class=n>questionAnswerArgumentCaptor</span> <span class=o>=</span> <span class=n>ArgumentCaptor</span><span class=o>.</span><span class=na>forClass</span><span class=o>(</span><span class=n>QuestionAnswer</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
<span class=ln>2</span>
<span class=ln>3</span> <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>questionAnswerRepository</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>save</span><span class=o>(</span><span class=n>questionAnswerArgumentCaptor</span><span class=o>.</span><span class=na>capture</span><span class=o>());</span>
<span class=ln>4</span>     <span class=n>var</span> <span class=n>actualQuestions</span> <span class=o>=</span> <span class=n>questionAnswerArgumentCaptor</span><span class=o>.</span><span class=na>getValue</span><span class=o>();</span>
<span class=ln>5</span>
</code></pre></div><ul>
<li>L’utilisation de SoftAssertions pour pouvoir vérifier plusieurs choses. Contrairement à une validation via la classe Assertions qui va lever une erreur à la première erreur, SoftAssertions va tester toutes les conditions et remonter les erreurs par la suite.</li>
</ul>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=ln>1</span> <span class=n>BDDSoftAssertions</span><span class=o>.</span><span class=na>thenSoftly</span><span class=o>(</span>
<span class=ln>2</span>     <span class=n>softly</span> <span class=o>-&gt;</span> <span class=o>{</span>
<span class=ln>3</span>       <span class=n>softly</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>actualQuestions</span><span class=o>).</span><span class=na>isNotNull</span><span class=o>();</span>
<span class=ln>4</span>       <span class=n>softly</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>actualQuestions</span><span class=o>)</span>
<span class=ln>5</span>               <span class=o>.</span><span class=na>extracting</span><span class=o>(</span><span class=s>&#34;form.questions&#34;</span><span class=o>,</span> <span class=n>Assertions</span><span class=o>.</span><span class=na>as</span><span class=o>(</span><span class=n>InstanceOfAssertFactories</span><span class=o>.</span><span class=na>COLLECTION</span><span class=o>))</span>
<span class=ln>6</span>               <span class=o>.</span><span class=na>hasSize</span><span class=o>(</span><span class=n>2</span><span class=o>);</span>
<span class=ln>7</span>     <span class=o>});</span>
</code></pre></div><h2 id=tests-dintégrations>Tests d’intégrations<a class="anchor ms-1" href=#tests-dintégrations><i class="fas fa-link"></i></a></h2>
<h3 id=paramétrage-du-test-1>Paramétrage du test<a class="anchor ms-1" href=#paramétrage-du-test-1><i class="fas fa-link"></i></a></h3>
<p>Pour la mise en place des tests d’intégration, nous allons créer un répertoire au même niveau que les répertoires test et main.</p>
<p><img class=img-fluid alt=integration-test-folder.png src=/fr/posts/comment-faire-evoluer-une-application-pour-la-rendre-plus-robuste-et-maintenable-mise-en-place-de-tests/integration-test-folder.png loading=lazy width=238 height=78>
</p>
<p>La séparation des tests unitaires et des tests d’intégration a l’avantage de nous permettre de distinguer quel type de tests on souhaite exécuter et quand cela aura son utilité lors de la mise en place de la CI/CD
La configuration se fera comme dans les tests unitaires via un fichier gradle séparé.</p>
<p><strong>Emplacement du fichier integration-test.gradle</strong></p>
<p><img class=img-fluid alt=unit-test-gradle-file-location.png src=/fr/posts/comment-faire-evoluer-une-application-pour-la-rendre-plus-robuste-et-maintenable-mise-en-place-de-tests/unit-test-gradle-file-location.png loading=lazy width=297 height=166>
</p>
<p><strong>Contenu du fichier integration-test.gradle</strong></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=ln> 1</span><span class=n>sourceSets</span> <span class=o>{</span>
<span class=ln> 2</span>    <span class=n>integrationTest</span> <span class=o>{</span>
<span class=ln> 3</span>        <span class=n>java</span> <span class=o>{</span>
<span class=ln> 4</span>            <span class=n>compileClasspath</span> <span class=o>+=</span> <span class=n>sourceSets</span><span class=o>.</span><span class=na>main</span><span class=o>.</span><span class=na>output</span>
<span class=ln> 5</span>            <span class=n>runtimeClasspath</span> <span class=o>+=</span> <span class=n>sourceSets</span><span class=o>.</span><span class=na>main</span><span class=o>.</span><span class=na>output</span>
<span class=ln> 6</span>            <span class=n>srcDir</span> <span class=nf>file</span><span class=o>(</span><span class=s1>&#39;src/integration-test/java&#39;</span><span class=o>)</span>
<span class=ln> 7</span>        <span class=o>}</span>
<span class=ln> 8</span>        <span class=n>resources</span><span class=o>.</span><span class=na>srcDir</span> <span class=nf>file</span><span class=o>(</span><span class=s1>&#39;src/integration-test/resources&#39;</span><span class=o>)</span>
<span class=ln> 9</span>    <span class=o>}</span>
<span class=ln>10</span><span class=o>}</span>
<span class=ln>11</span>
<span class=ln>12</span><span class=n>configurations</span> <span class=o>{</span>
<span class=ln>13</span>    <span class=n>integrationTestImplementation</span><span class=o>.</span><span class=na>extendsFrom</span> <span class=n>implementation</span>
<span class=ln>14</span>    <span class=n>integrationTestRuntimeOnly</span><span class=o>.</span><span class=na>extendsFrom</span> <span class=n>runtimeOnly</span>
<span class=ln>15</span><span class=o>}</span>
<span class=ln>16</span>
<span class=ln>17</span><span class=n>dependencies</span> <span class=o>{</span>
<span class=ln>18</span>    <span class=n>integrationTestImplementation</span> <span class=nl>group:</span> <span class=s1>&#39;org.springframework.boot&#39;</span><span class=o>,</span> <span class=nl>name:</span> <span class=s1>&#39;spring-boot-starter-test&#39;</span>
<span class=ln>19</span>    <span class=n>integrationTestImplementation</span> <span class=nl>group:</span> <span class=s1>&#39;org.mockito&#39;</span><span class=o>,</span> <span class=nl>name:</span> <span class=s1>&#39;mockito-core&#39;</span><span class=o>,</span> <span class=nl>version:</span> <span class=s1>&#39;4.2.0&#39;</span>
<span class=ln>20</span>    <span class=n>integrationTestImplementation</span> <span class=nl>group:</span> <span class=s1>&#39;org.mockito&#39;</span><span class=o>,</span> <span class=nl>name:</span> <span class=s1>&#39;mockito-inline&#39;</span><span class=o>,</span> <span class=nl>version:</span> <span class=s1>&#39;4.2.0&#39;</span>
<span class=ln>21</span><span class=o>}</span>
<span class=ln>22</span>
<span class=ln>23</span><span class=n>tasks</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=s1>&#39;integrationTest&#39;</span><span class=o>,</span> <span class=n>Test</span><span class=o>)</span> <span class=o>{</span>
<span class=ln>24</span>    <span class=n>description</span> <span class=o>=</span> <span class=s1>&#39;Runs integration tests.&#39;</span>
<span class=ln>25</span>    <span class=n>group</span> <span class=o>=</span> <span class=s1>&#39;verification&#39;</span>
<span class=ln>26</span>
<span class=ln>27</span>    <span class=n>testClassesDirs</span> <span class=o>=</span> <span class=n>sourceSets</span><span class=o>.</span><span class=na>integrationTest</span><span class=o>.</span><span class=na>output</span><span class=o>.</span><span class=na>classesDirs</span>
<span class=ln>28</span>    <span class=n>classpath</span> <span class=o>=</span> <span class=n>sourceSets</span><span class=o>.</span><span class=na>integrationTest</span><span class=o>.</span><span class=na>runtimeClasspath</span>
<span class=ln>29</span>    <span class=n>shouldRunAfter</span> <span class=n>test</span>
<span class=ln>30</span>    <span class=nf>useJUnitPlatform</span><span class=o>()</span>
<span class=ln>31</span><span class=o>}</span>
<span class=ln>32</span>
<span class=ln>33</span><span class=n>check</span><span class=o>.</span><span class=na>dependsOn</span> <span class=n>integrationTest</span>
</code></pre></div><p><strong>Dans le fichier build.gradle</strong></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=ln>1</span><span class=n>apply</span> <span class=nl>from:</span> <span class=s2>&#34;gradle/unit-test.gradle&#34;</span>
<span class=ln>2</span><span class=n>apply</span> <span class=nl>from:</span> <span class=s2>&#34;gradle/integration-test.gradle&#34;</span>
<span class=ln>3</span>
</code></pre></div><h3 id=mise-en-place-dun-test-1>Mise en place d’un test<a class="anchor ms-1" href=#mise-en-place-dun-test-1><i class="fas fa-link"></i></a></h3>
<p>La durée des tests d’intégrations étant plus longs, on va les limiter aux controllers et aux repositories ; les services, ont l’a vu plus haut, sont testés par des tests unitaires.
Au niveau des controllers on aura pour objectifs de vérifier que les endpoints répondent correctement, c&rsquo;est-à-dire qu’on vérifiera :</p>
<ul>
<li>la validité du statut retourné.</li>
<li>la remontée d’erreur suite à une invalidité des paramètres ou dans le corp de la requête</li>
</ul>
<p>Les services appelés dans les controllers seront mockés, les appels aux méthodes des services pourront être validés.
Cette façon de tester nous fait comprendre pourquoi il faut limiter le code métier dans les controllers.
Au niveau des repositories nous vérifierons la validité des requêtes, on se concentrera dans un premier temps sur les requêtes les plus complexes.</p>
<p><strong>Exemple de test d&rsquo;intégration d’un controller</strong></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=ln> 1</span><span class=nd>@WebMvcTest</span><span class=o>(</span><span class=n>controllers</span> <span class=o>=</span> <span class=n>InterviewController</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
<span class=ln> 2</span><span class=kd>public</span> <span class=kd>class</span> <span class=nc>InterviewControllerITest</span> <span class=o>{</span>
<span class=ln> 3</span>
<span class=ln> 4</span> <span class=nd>@Autowired</span> <span class=n>Jackson2ObjectMapperBuilder</span> <span class=n>mapperBuilder</span><span class=o>;</span>
<span class=ln> 5</span>
<span class=ln> 6</span> <span class=nd>@Autowired</span> <span class=kd>private</span> <span class=n>MockMvc</span> <span class=n>mockMvc</span><span class=o>;</span>
<span class=ln> 7</span>
<span class=ln> 8</span> <span class=nd>@MockBean</span> <span class=kd>private</span> <span class=n>InterviewService</span> <span class=n>interviewService</span><span class=o>;</span>
<span class=ln> 9</span>
<span class=ln>10</span> <span class=nd>@Test</span>
<span class=ln>11</span> <span class=nd>@DisplayName</span><span class=o>(</span><span class=s>&#34;Should get all interviews&#34;</span><span class=o>)</span>
<span class=ln>12</span> <span class=kt>void</span> <span class=nf>should_get_persons</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
<span class=ln>13</span>   <span class=c1>// when
</span><span class=ln>14</span><span class=c1></span>   <span class=n>mockMvc</span>
<span class=ln>15</span>       <span class=o>.</span><span class=na>perform</span><span class=o>(</span>
<span class=ln>16</span>           <span class=n>MockMvcRequestBuilders</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;/interviews&#34;</span><span class=o>)</span>
<span class=ln>17</span>               <span class=o>.</span><span class=na>contentType</span><span class=o>(</span><span class=n>MediaType</span><span class=o>.</span><span class=na>APPLICATION_JSON</span><span class=o>)</span>
<span class=ln>18</span>               <span class=o>.</span><span class=na>accept</span><span class=o>(</span><span class=n>MediaType</span><span class=o>.</span><span class=na>APPLICATION_JSON</span><span class=o>))</span>
<span class=ln>19</span>       <span class=o>.</span><span class=na>andExpect</span><span class=o>(</span><span class=n>MockMvcResultMatchers</span><span class=o>.</span><span class=na>status</span><span class=o>().</span><span class=na>isOk</span><span class=o>());</span>
<span class=ln>20</span>
<span class=ln>21</span>   <span class=c1>// then
</span><span class=ln>22</span><span class=c1></span>   <span class=n>BDDMockito</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>interviewService</span><span class=o>).</span><span class=na>should</span><span class=o>().</span><span class=na>findAll</span><span class=o>();</span>
<span class=ln>23</span> <span class=o>}</span>
<span class=ln>24</span>
<span class=ln>25</span>
</code></pre></div><p><strong>Exemple de test d&rsquo;intégration d’un repository</strong></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=ln> 1</span>
<span class=ln> 2</span><span class=nd>@DataJpaTest</span>
<span class=ln> 3</span><span class=nd>@ActiveProfiles</span><span class=o>(</span><span class=s>&#34;it&#34;</span><span class=o>)</span>
<span class=ln> 4</span><span class=kd>public</span> <span class=kd>class</span> <span class=nc>FormRepositoryITest</span> <span class=o>{</span>
<span class=ln> 5</span>   <span class=nd>@Autowired</span>
<span class=ln> 6</span>   <span class=kd>private</span> <span class=n>FormRepository</span> <span class=n>formRepository</span><span class=o>;</span>
<span class=ln> 7</span>
<span class=ln> 8</span>   <span class=nd>@Test</span>
<span class=ln> 9</span>   <span class=kt>void</span> <span class=nf>should_create_form</span><span class=o>()</span> <span class=o>{</span>
<span class=ln>10</span>       <span class=c1>// given
</span><span class=ln>11</span><span class=c1></span>       <span class=n>var</span> <span class=n>questionAnswer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>QuestionAnswer</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=s>&#34;What do you think about your work this year&#34;</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
<span class=ln>12</span>       <span class=n>var</span> <span class=n>formToSave</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Form</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=n>Set</span><span class=o>.</span><span class=na>of</span><span class=o>(</span><span class=n>questionAnswer</span><span class=o>));</span>
<span class=ln>13</span>
<span class=ln>14</span>       <span class=c1>// when
</span><span class=ln>15</span><span class=c1></span>       <span class=n>var</span> <span class=n>actualForm</span> <span class=o>=</span> <span class=n>formRepository</span><span class=o>.</span><span class=na>save</span><span class=o>(</span><span class=n>formToSave</span><span class=o>);</span>
<span class=ln>16</span>
<span class=ln>17</span>       <span class=c1>// then
</span><span class=ln>18</span><span class=c1></span>       <span class=n>var</span> <span class=n>idNotNull</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Condition</span><span class=o>&lt;</span><span class=n>Form</span><span class=o>&gt;((</span><span class=n>Form</span> <span class=n>form</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=n>form</span><span class=o>.</span><span class=na>getId</span><span class=o>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>,</span> <span class=s>&#34;form id not null&#34;</span><span class=o>);</span>
<span class=ln>19</span>       <span class=n>var</span> <span class=n>asOneQuestion</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Condition</span><span class=o>&lt;</span><span class=n>Form</span><span class=o>&gt;((</span><span class=n>Form</span> <span class=n>form</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=n>form</span><span class=o>.</span><span class=na>getQuestions</span><span class=o>().</span><span class=na>size</span><span class=o>()</span> <span class=o>==</span> <span class=n>1</span><span class=o>,</span> <span class=s>&#34;form has only one question&#34;</span><span class=o>);</span>
<span class=ln>20</span>       <span class=n>BDDAssertions</span><span class=o>.</span><span class=na>then</span><span class=o>(</span><span class=n>actualForm</span><span class=o>)</span>
<span class=ln>21</span>               <span class=o>.</span><span class=na>as</span><span class=o>(</span><span class=s>&#34;Check if a new form has been saved.&#34;</span><span class=o>)</span>
<span class=ln>22</span>               <span class=o>.</span><span class=na>has</span><span class=o>(</span><span class=n>idNotNull</span><span class=o>)</span>
<span class=ln>23</span>               <span class=o>.</span><span class=na>has</span><span class=o>(</span><span class=n>asOneQuestion</span><span class=o>);</span>
<span class=ln>24</span>   <span class=o>}</span>
<span class=ln>25</span>
<span class=ln>26</span>
</code></pre></div><h3 id=détail-du-code-1>Détail du code<a class="anchor ms-1" href=#détail-du-code-1><i class="fas fa-link"></i></a></h3>
<h4 id=test-des-endpoints>Test des endpoints<a class="anchor ms-1" href=#test-des-endpoints><i class="fas fa-link"></i></a></h4>
<p>Pour les tests des endpoints on annote les classes tests avec <a href=https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/test/autoconfigure/web/servlet/WebMvcTest.html target=_blank rel="noopener noreferrer">@WebMvcTest</a>
, qui permet de charger un environnement minimal afin de pouvoir tester uniquement le controller défini dans l’annotation.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=ln>1</span><span class=nd>@WebMvcTest</span><span class=o>(</span><span class=n>controllers</span> <span class=o>=</span> <span class=n>InterviewController</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</code></pre></div><p>La classe MockMvc de spring permet de tester les endpoint sans pour autant charger tout le contexte de l’application.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=ln>1</span>   <span class=n>mockMvc</span>
<span class=ln>2</span>       <span class=o>.</span><span class=na>perform</span><span class=o>(</span>
<span class=ln>3</span>           <span class=n>MockMvcRequestBuilders</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=s>&#34;/interviews&#34;</span><span class=o>)</span>
<span class=ln>4</span>               <span class=o>.</span><span class=na>contentType</span><span class=o>(</span><span class=n>MediaType</span><span class=o>.</span><span class=na>APPLICATION_JSON</span><span class=o>)</span>
<span class=ln>5</span>               <span class=o>.</span><span class=na>accept</span><span class=o>(</span><span class=n>MediaType</span><span class=o>.</span><span class=na>APPLICATION_JSON</span><span class=o>))</span>
<span class=ln>6</span>       <span class=o>.</span><span class=na>andExpect</span><span class=o>(</span><span class=n>MockMvcResultMatchers</span><span class=o>.</span><span class=na>status</span><span class=o>().</span><span class=na>isOk</span><span class=o>());</span>
</code></pre></div><p>Afin de tester uniquement l&rsquo;endpoint (code retour, objet retourné …) on mock le service qui est appelé avec l’annotation @MockBean de spring</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=ln>1</span> <span class=nd>@MockBean</span> <span class=kd>private</span> <span class=n>InterviewService</span> <span class=n>interviewService</span><span class=o>;</span>
</code></pre></div><h4 id=test-des-repositories>Test des repositories<a class="anchor ms-1" href=#test-des-repositories><i class="fas fa-link"></i></a></h4>
<p>Les tests d&rsquo;intégration entre un repository et la bases de données se fait avec l’annotation <code>@DataJpaTest </code>
Lors d’un test d’enregistrement d’un objet, il est possible de vérifier l’identifiant généré de l’objet en retour
Pour des méthodes de type find, findAll, findId nous pouvons utiliser l&rsquo;annotation @Sql afin de peupler la base de données avant de faire le test. Ceci se révèle utile lorsque la base de données au démarrage est vide. Ici je ne l’ai pas fait, mais il est tout à fait possible de démarrer les tests avec une base de données pré-initialisée.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=ln>1</span><span class=nd>@Sql</span><span class=o>(</span><span class=n>scripts</span> <span class=o>=</span> <span class=o>{</span><span class=s>&#34;/sql_scripts/initialize_form.sql&#34;</span><span class=o>}</span> <span class=o>)</span>
</code></pre></div><h2 id=tests-system>Tests system<a class="anchor ms-1" href=#tests-system><i class="fas fa-link"></i></a></h2>
<h3 id=paramétrage-du-test-2>Paramétrage du test<a class="anchor ms-1" href=#paramétrage-du-test-2><i class="fas fa-link"></i></a></h3>
<p>Tout comme pour les tests d’intégration les tests system sont dans un répertoire distinct ; La configuration se trouve dans le fichier system-test.gradle</p>
<p><img class=img-fluid alt=system-test-folder.png src=/fr/posts/comment-faire-evoluer-une-application-pour-la-rendre-plus-robuste-et-maintenable-mise-en-place-de-tests/system-test-folder.png loading=lazy width=265 height=103>
</p>
<p><strong>Emplacement du fichier system-test.gradle</strong></p>
<p><img class=img-fluid alt=system-test-gradle-file-location.png src=/fr/posts/comment-faire-evoluer-une-application-pour-la-rendre-plus-robuste-et-maintenable-mise-en-place-de-tests/system-test-gradle-file-location.png loading=lazy width=335 height=118>
</p>
<p><strong>Contenu du fichiersystem-test.gradle</strong></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=ln> 1</span><span class=n>sourceSets</span> <span class=o>{</span>
<span class=ln> 2</span>   <span class=n>systemTest</span> <span class=o>{</span>
<span class=ln> 3</span>       <span class=n>java</span> <span class=o>{</span>
<span class=ln> 4</span>           <span class=n>compileClasspath</span> <span class=o>+=</span> <span class=n>sourceSets</span><span class=o>.</span><span class=na>main</span><span class=o>.</span><span class=na>output</span>
<span class=ln> 5</span>           <span class=n>runtimeClasspath</span> <span class=o>+=</span> <span class=n>sourceSets</span><span class=o>.</span><span class=na>main</span><span class=o>.</span><span class=na>output</span>
<span class=ln> 6</span>           <span class=n>srcDir</span> <span class=nf>file</span><span class=o>(</span><span class=s1>&#39;src/system-test/java&#39;</span><span class=o>)</span>
<span class=ln> 7</span>       <span class=o>}</span>
<span class=ln> 8</span>       <span class=n>resources</span><span class=o>.</span><span class=na>srcDir</span> <span class=nf>file</span><span class=o>(</span><span class=s1>&#39;src/system-test/resources&#39;</span><span class=o>)</span>
<span class=ln> 9</span>   <span class=o>}</span>
<span class=ln>10</span><span class=o>}</span>
<span class=ln>11</span>
<span class=ln>12</span><span class=n>configurations</span> <span class=o>{</span>
<span class=ln>13</span>   <span class=n>systemTestImplementation</span><span class=o>.</span><span class=na>extendsFrom</span> <span class=n>implementation</span>
<span class=ln>14</span>   <span class=n>systemTestRuntimeOnly</span><span class=o>.</span><span class=na>extendsFrom</span> <span class=n>runtimeOnly</span>
<span class=ln>15</span><span class=o>}</span>
<span class=ln>16</span>
<span class=ln>17</span><span class=n>dependencies</span> <span class=o>{</span>
<span class=ln>18</span>   <span class=n>systemTestImplementation</span> <span class=nl>group:</span> <span class=s1>&#39;org.springframework.boot&#39;</span><span class=o>,</span> <span class=nl>name:</span> <span class=s1>&#39;spring-boot-starter-test&#39;</span>
<span class=ln>19</span>   <span class=n>systemTestImplementation</span> <span class=nl>group:</span> <span class=s1>&#39;io.rest-assured&#39;</span><span class=o>,</span> <span class=nl>name:</span> <span class=s1>&#39;rest-assured&#39;</span><span class=o>,</span> <span class=nl>version:</span> <span class=s1>&#39;4.4.0&#39;</span>
<span class=ln>20</span>   <span class=n>systemTestImplementation</span> <span class=nl>group:</span> <span class=s1>&#39;org.mockito&#39;</span><span class=o>,</span> <span class=nl>name:</span> <span class=s1>&#39;mockito-core&#39;</span><span class=o>,</span> <span class=nl>version:</span> <span class=s1>&#39;4.2.0&#39;</span>
<span class=ln>21</span>   <span class=n>systemTestImplementation</span> <span class=nl>group:</span> <span class=s1>&#39;org.mockito&#39;</span><span class=o>,</span> <span class=nl>name:</span> <span class=s1>&#39;mockito-inline&#39;</span><span class=o>,</span> <span class=nl>version:</span> <span class=s1>&#39;4.2.0&#39;</span>
<span class=ln>22</span>
<span class=ln>23</span>
<span class=ln>24</span><span class=o>}</span>
<span class=ln>25</span>
</code></pre></div><p><strong>Dans le fichier build.gradle</strong></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=ln>1</span>
<span class=ln>2</span><span class=n>apply</span> <span class=nl>from:</span> <span class=s2>&#34;gradle/unit-test.gradle&#34;</span>
<span class=ln>3</span><span class=n>apply</span> <span class=nl>from:</span> <span class=s2>&#34;gradle/integration-test.gradle&#34;</span>
<span class=ln>4</span><span class=n>apply</span> <span class=nl>from:</span> <span class=s2>&#34;gradle/system-test.gradle&#34;</span>
<span class=ln>5</span>
<span class=ln>6</span><span class=n>systemTest</span> <span class=o>{</span>
<span class=ln>7</span>  <span class=n>shouldRunAfter</span> <span class=n>integrationTest</span>
<span class=ln>8</span><span class=o>}</span>
<span class=ln>9</span>
</code></pre></div><h3 id=mise-en-place-dun-test-2>Mise en place d’un test<a class="anchor ms-1" href=#mise-en-place-dun-test-2><i class="fas fa-link"></i></a></h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=ln> 1</span>
<span class=ln> 2</span><span class=nd>@SpringBootTest</span><span class=o>(</span><span class=n>webEnvironment</span> <span class=o>=</span> <span class=n>SpringBootTest</span><span class=o>.</span><span class=na>WebEnvironment</span><span class=o>.</span><span class=na>RANDOM_PORT</span><span class=o>)</span>
<span class=ln> 3</span><span class=kd>class</span> <span class=nc>PostInterviewTest</span> <span class=o>{</span>
<span class=ln> 4</span> <span class=nd>@Autowired</span> <span class=n>Jackson2ObjectMapperBuilder</span> <span class=n>mapperBuilder</span><span class=o>;</span>
<span class=ln> 5</span>
<span class=ln> 6</span> <span class=nd>@LocalServerPort</span>
<span class=ln> 7</span>
<span class=ln> 8</span> <span class=kd>private</span> <span class=n>Integer</span> <span class=n>port</span><span class=o>;</span>
<span class=ln> 9</span>
<span class=ln>10</span> <span class=nd>@BeforeAll</span>
<span class=ln>11</span> <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>setup</span><span class=o>()</span> <span class=o>{</span>
<span class=ln>12</span>   <span class=n>RestAssured</span><span class=o>.</span><span class=na>baseURI</span> <span class=o>=</span> <span class=s>&#34;http://localhost&#34;</span><span class=o>;</span>
<span class=ln>13</span> <span class=o>}</span>
<span class=ln>14</span> <span class=nd>@Test</span>
<span class=ln>15</span> <span class=nd>@Sql</span><span class=o>(</span><span class=n>scripts</span> <span class=o>=</span> <span class=s>&#34;/sql_scripts/init_database.sql&#34;</span><span class=o>)</span>
<span class=ln>16</span> <span class=kt>void</span> <span class=nf>should_create_interview</span><span class=o>()</span> <span class=kd>throws</span> <span class=n>JsonProcessingException</span> <span class=o>{</span>
<span class=ln>17</span>   <span class=n>var</span> <span class=n>manager</span> <span class=o>=</span>
<span class=ln>18</span>       <span class=k>new</span> <span class=n>Person</span><span class=o>(</span><span class=n>UUID</span><span class=o>.</span><span class=na>fromString</span><span class=o>(</span><span class=s>&#34;8a37adbc-0c29-491a-8b6f-f10a4219fb91&#34;</span><span class=o>),</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
<span class=ln>19</span>   <span class=n>var</span> <span class=n>employee</span> <span class=o>=</span>
<span class=ln>20</span>       <span class=k>new</span> <span class=n>Person</span><span class=o>(</span><span class=n>UUID</span><span class=o>.</span><span class=na>fromString</span><span class=o>(</span><span class=s>&#34;3556c835-3bcd-420e-bb6e-a8b7c0bb139d&#34;</span><span class=o>),</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>null</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
<span class=ln>21</span>   <span class=n>var</span> <span class=n>form</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Form</span><span class=o>(</span><span class=n>UUID</span><span class=o>.</span><span class=na>fromString</span><span class=o>(</span><span class=s>&#34;df9b2aad-d32e-469e-b434-be71a5531a35&#34;</span><span class=o>),</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;&gt;());</span>
<span class=ln>22</span>   <span class=n>var</span> <span class=n>interview</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Interview</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=n>Instant</span><span class=o>.</span><span class=na>now</span><span class=o>(),</span> <span class=n>manager</span><span class=o>,</span> <span class=n>employee</span><span class=o>,</span> <span class=n>form</span><span class=o>);</span>
<span class=ln>23</span>
<span class=ln>24</span>   <span class=n>RestAssured</span><span class=o>.</span><span class=na>given</span><span class=o>()</span>
<span class=ln>25</span>           <span class=o>.</span><span class=na>header</span><span class=o>(</span><span class=s>&#34;Content-type&#34;</span><span class=o>,</span> <span class=s>&#34;application/json&#34;</span><span class=o>)</span>
<span class=ln>26</span>           <span class=o>.</span><span class=na>and</span><span class=o>()</span>
<span class=ln>27</span>           <span class=o>.</span><span class=na>port</span><span class=o>(</span><span class=n>port</span><span class=o>)</span>
<span class=ln>28</span>       <span class=o>.</span><span class=na>body</span><span class=o>(</span><span class=n>mapperBuilder</span><span class=o>.</span><span class=na>build</span><span class=o>().</span><span class=na>writeValueAsString</span><span class=o>(</span><span class=n>interview</span><span class=o>))</span>
<span class=ln>29</span>       <span class=o>.</span><span class=na>when</span><span class=o>()</span>
<span class=ln>30</span>           <span class=o>.</span><span class=na>post</span><span class=o>(</span><span class=s>&#34;/interviews&#34;</span><span class=o>)</span>
<span class=ln>31</span>       <span class=o>.</span><span class=na>then</span><span class=o>()</span>
<span class=ln>32</span>           <span class=o>.</span><span class=na>statusCode</span><span class=o>(</span><span class=n>HttpStatus</span><span class=o>.</span><span class=na>SC_CREATED</span><span class=o>);</span>
<span class=ln>33</span> <span class=o>}</span>
<span class=ln>34</span><span class=o>}</span>
<span class=ln>35</span>
</code></pre></div><h3 id=détails-du-code>Détails du code<a class="anchor ms-1" href=#détails-du-code><i class="fas fa-link"></i></a></h3>
<p>Les points à noter dans ce test sont :</p>
<ul>
<li>L’utilisation de l’annotation SpringBootTest qui permet de charger l’ensemble du contexte spring.</li>
<li>L’utilisation de RestAssured pour tester les endpoints.</li>
</ul>
<h2 id=résumé>Résumé<a class="anchor ms-1" href=#résumé><i class="fas fa-link"></i></a></h2>
<ul>
<li>Il existe trois types de bases de tests : les tests unitaires qui testent une méthode et uniquement le contenu de la méthode, les tests d’intégration qui valident la bonne intégration entre deux couches (appel des endpoints, connexion repository / base de données) et enfin les tests systèmes qui permettent de valider le bon fonctionnement d’une fonctionnalité</li>
<li>Pour une API existante et dépourvue de tests, il est possible de commencer par la mise en place de tests système sur les endpoints les plus critiques puis d’ajouter progressivement des tests d’intégration et des tests unitaires.</li>
<li>Pour une nouvelle API il est préférable de commencer par des tests unitaires et de progresser vers les tests systèmes</li>
</ul>
<p>Si vous avez des remarques sur le contenu, la forme vous pouvez laisser un commentaire… c’est en échangeant qu’on progresse.</p>
<p>Écrit par : Emmanuel Quinton
Revue par : Daniele Cremonini</p></div><hr><div class=post-copyright id=post-copyright>
<a class="d-flex align-items-center flex-column" target=_blank rel="license noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en>
<span><i class="fab fa-fw fa-2x fa-creative-commons"></i><i class="fab fa-fw fa-2x fa-creative-commons-by"></i><i class="fab fa-fw fa-2x fa-creative-commons-nc"></i><i class="fab fa-fw fa-2x fa-creative-commons-nd"></i></span>
CC BY-NC-ND 4.0
</a>
</div>
<hr><div class="post-navs d-flex mb-3 justify-content-evenly">
<div class="post-nav post-prev"><i class="fas fa-fw fa-chevron-left"></i>
<a href=/fr/posts/qu-est-ce-que-la-mise-en-page-du-code-et-pourquoi-est-ce-important/>Qu'est-Ce Que La Mise en Page Du Code Et Pourquoi Est-Ce Important
</a>
</div></div></div>
</article><section class="related-posts row card component">
<div class=card-header>
<h2 class=card-title>Articles en Relations</h2>
</div>
<div class=card-body>
<ul class=post-list><li>
<a href=/fr/posts/qu-est-ce-que-la-mise-en-page-du-code-et-pourquoi-est-ce-important/>Qu'est-Ce Que La Mise en Page Du Code Et Pourquoi Est-Ce Important
</a>
<span class="float-end post-date">12-10-2022
</span>
</li><li>
<a href=/fr/posts/comment-faire-evoluer-application-presentation/>Comment Faire Évoluer Une API Pour La Rendre Plus Robuste Et Maintenable - Presentation
</a>
<span class="float-end post-date">15-02-2022
</span>
</li><li>
<a href=/fr/about/>About
</a>
<span class="float-end post-date">13-01-2022
</span>
</li><li>
<a href=/fr/contact/>
</a>
<span class="float-end post-date">01-01-0001
</span>
</li><li>
<a href=/fr/offline/>Hors Ligne
</a>
<span class="float-end post-date">01-01-0001
</span>
</li></ul>
</div>
</section><div class="card component row post-comments" id=post-comments>
<div class=card-header>
<h2 class=card-title>Commentaires</h2>
</div>
<div class=card-body></div>
</div></div>
</div><aside class="col-lg-4 sidebar d-flex">
<div class=container>
<section class="card row text-center profile component">
<div class=card-body>
<div class="col-12 d-flex align-items-center justify-content-center"><img class="profile-avatar rounded-circle" alt="Talk To The Duck" src=/images/duck_120x120_square.png loading=lazy width=120 height=120>
</div>
<div class="col-12 profile-meta"><div class=profile-name>Talk To The Duck</div><div class=profile-bio>Explain to the Duck, you will understand.</div><div class=profile-location><i class="fas fa-fw fa-map-marker-alt"></i>Paris, France</div><div class=profile-about><i class="fas fa-fw fa-user"></i><a href=/fr/about/>About</a></div><div class=profile-contact><i class="fas fa-fw fa-question-circle"></i><a href=/fr/contact/></a></div></div>
</div>
</section>
<section class="recent-posts row card component">
<div class=card-header>
<h2 class=card-title>Articles Récents</h2>
</div>
<div class=card-body>
<ul class=post-list><li>
<a href=/fr/posts/comment-faire-evoluer-une-application-pour-la-rendre-plus-robuste-et-maintenable-mise-en-place-de-tests/>Comment Faire Évoluer Une Application Pour La Rendre Plus Robuste Et Maintenable - Mise en Place De Tests
</a>
</li><li>
<a href=/fr/posts/qu-est-ce-que-la-mise-en-page-du-code-et-pourquoi-est-ce-important/>Qu'est-Ce Que La Mise en Page Du Code Et Pourquoi Est-Ce Important
</a>
</li><li>
<a href=/fr/posts/comment-faire-evoluer-application-presentation/>Comment Faire Évoluer Une API Pour La Rendre Plus Robuste Et Maintenable - Presentation
</a>
</li></ul>
</div>
</section><section class="taxonomies row card component">
<div class=card-header>
<h2 class=card-title>
<a href=/fr/categories>Catégories</a>
</h2>
</div>
<div class=card-body>
<div class=py-2><a href=/fr/categories/qualit%C3%A9/ class="badge rounded post-taxonomy" title=qualité>
qualité
</a><a href=/fr/categories/test/ class="badge rounded post-taxonomy" title=test>
test
</a></div>
</div>
</section><section class="taxonomies row card component">
<div class=card-header>
<h2 class=card-title>
<a href=/fr/series>Séries</a>
</h2>
</div>
<div class=card-body>
<div class=py-2><a href=/fr/series/comment-faire-%C3%A9voluer-une-application-pour-la-rendre-plus-robuste-et-maintenable/ class="badge rounded post-taxonomy" title="Comment faire évoluer une application pour la rendre plus robuste et maintenable">
Comment faire évoluer une application pour la rendre plus robuste et maintenable
</a><a href=/fr/series/outils-pour-java/ class="badge rounded post-taxonomy" title="Outils pour Java">
Outils pour Java
</a></div>
</div>
</section>
</div>
</aside>
</div>
</main><footer class="footer mt-auto py-3 text-center container"><nav class="social-links nav justify-content-center mb-2"></nav>
<div class="copyright mb-2">
<a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png></a><br>This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
Copyright © 2021-2023 Talk To The Duck. All Rights Reserved.
</div>
</footer>
<script src=/js/main.min.d1ef5819d5055b58eaa52e77fc1c87e27b1a006bc5169ce78255477ef0bb2281.js integrity="sha256-0e9YGdUFW1jqpS53/ByH4nsaAGvFFpznglVHfvC7IoE=" crossorigin=anonymous defer></script><script src=/js/icons.min.a35670f2f90c398e5ee5c8e509b428fae75aa2746854cee10b60794633076859.js integrity="sha256-o1Zw8vkMOY5e5cjlCbQo+udaonRoVM7hC2B5RjMHaFk=" crossorigin=anonymous defer></script>
<script>'serviceWorker'in navigator&&window.addEventListener('load',()=>{navigator.serviceWorker.register('/service-worker.js').then(function(a){console.log('Successfully registered service worker',a)}).catch(function(a){console.warn('Error whilst registering service worker',a)})})</script><script src=/js/viewer.min.4dba52a0a790f909408b7385316651299158381686401d50ff1f04dda6476473.js integrity="sha256-TbpSoKeQ+QlAi3OFMWZRKZFYOBaGQB1Q/x8E3aZHZHM=" crossorigin=anonymous defer></script>
</body>
</html>